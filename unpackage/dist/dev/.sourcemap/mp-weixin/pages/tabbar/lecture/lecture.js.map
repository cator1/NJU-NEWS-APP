{"version":3,"file":"lecture.js","sources":["pages/tabbar/lecture/lecture.vue","../../HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvdGFiYmFyL2xlY3R1cmUvbGVjdHVyZS52dWU"],"sourcesContent":["<template>\n  <view class=\"tabs\">\n    <!-- 顶部固定导航栏 -->\n    <view class=\"tab-bar\">\n      <view\n        class=\"uni-tab-item\"\n        v-for=\"(tab, index) in tabList\"\n        :key=\"tab.id\"\n        :data-current=\"index\"\n        @click=\"ontabtap\"\n        :class=\"{ 'uni-tab-item-active': tabIndex == index }\"\n      >\n        <text class=\"uni-tab-item-title\">{{ tab.name }}</text>\n      </view>\n    </view>\n\n    <!-- 内容区 -->\n    <swiper class=\"tab-box\" :current=\"tabIndex\" :duration=\"300\" @change=\"onswiperchange\">\n      <swiper-item\n        class=\"swiper-item\"\n        v-for=\"(tab, index) in tabList\"\n        :key=\"tab.id\"\n      >\n        <scroll-view scroll-y class=\"scroll-list\">\n          <uni-list v-if=\"getListByIndex(index).length > 0\">\n            <uni-list-item\n              v-for=\"(item, i) in getListByIndex(index)\"\n              :key=\"i\"\n              showArrow\n              clickable\n              @click=\"goToDetail(item)\"\n            >\n              <template v-slot:body>\n                <view class=\"list-item-box\">\n                  <text class=\"title\">{{ item.title }}</text>\n                  <text class=\"desc\">{{ renderDescription(item, index) }}</text>\n                </view>\n              </template>\n            </uni-list-item>\n          </uni-list>\n          <view v-else class=\"empty-tip\">暂无内容</view>\n\n          <!-- 底部占位，避免无法滚动 -->\n          <view class=\"bottom-spacer\"></view>\n        </scroll-view>\n      </swiper-item>\n    </swiper>\n  </view>\n</template>\n\n<script>\nimport { useUserStore } from '../../../store/user';\n\nexport default {\n  data() {\n    return {\n      tabList: [\n        { id: 'tab01', name: '今日讲座' },\n        { id: 'tab02', name: '近期上新' }\n      ],\n      tabIndex: 0,\n      descriptionMap: {} // 仅用于 index=0\n    };\n  },\n  computed: {\n    userStore() {\n      return useUserStore();\n    },\n    todayLectures() {\n      const list = this.userStore.userInfo?.due.lecture || [];\n      const todayList = list.filter(item => item.due_time === this.todayStr);\n      this.enrichDescriptions(todayList); // 异步加载 description\n      return todayList;\n    },\n    todayStr() {\n      const now = new Date();\n      const yyyy = now.getFullYear();\n      const mm = String(now.getMonth() + 1).padStart(2, '0');\n      const dd = String(now.getDate()).padStart(2, '0');\n      return `${yyyy}-${mm}-${dd}`;\n    }\n  },\n  methods: {\n    ontabtap(e) {\n      const index = Number(e.currentTarget.dataset.current);\n      this.tabIndex = index;\n    },\n    onswiperchange(e) {\n      this.tabIndex = e.detail.current;\n    },\n    getListByIndex(index) {\n      const info = this.userStore.userInfo?.data || {};\n      if (index === 0) return this.todayLectures || [];\n      if (index === 1) return info.lecture || [];\n      return [];\n    },\n    renderDescription(item, index) {\n      if (index === 0) {\n        const cached = this.descriptionMap[item.id];\n        return cached\n          ? cached.map(d => d.content).join('\\n')\n          : '加载中...';\n      } else {\n        return this.getTextContent(item.description);\n      }\n    },\n    getTextContent(descList) {\n      if (!Array.isArray(descList)) return '';\n      return descList\n        .filter(d => d.type === 'text')\n        .map(d => d.content)\n        .join('\\n');\n    },\n    enrichDescriptions(list) {\n      list.forEach(item => {\n        const id = item.id;\n        if (!id || this.descriptionMap[id]) return;\n\n        const cacheKey = `lecture_desc_${id}`;\n        const cached = uni.getStorageSync(cacheKey);\n        if (cached) {\n          this.$set(this.descriptionMap, id, [{ content: cached }]);\n          return;\n        }\n\t\tconst backupUrlFetcher = 'https://nik-nul.github.io/keep/url.txt';\n        uni.request({\n          url: `http://52.184.65.42/api/query?id=${id}`,\n          method: 'GET',\n          success: (res) => {\n            if (res.statusCode === 200 && Array.isArray(res.data) && res.data.length > 0) {\n              const desc = res.data[0][5];\n              this.$set(this.descriptionMap, id, [{ content: desc }]);\n              uni.setStorageSync(cacheKey, desc);\n            }\n          },\n          fail: () => {\n            console.warn(`讲座 ${id} 请求失败,尝试备用地址`);\r\n\t\t\t\r\n\t\t\tuni.request({\r\n\t\t\t\turl:backupUrlFetcher,\r\n\t\t\t\tmethod:'GET',\r\n\t\t\t\tsuccess(backres) {\r\n\t\t\t\t\tconst newBaseurl = backres.data.trim();\r\n\t\t\t\t\tif(!newBaseurl){\r\n\t\t\t\t\t\tconsole.error('备用地址为空');\r\n\t\t\t\t\t\treturn;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tconst newurl = `http://${newBaseurl}/api/query?id=${id}`;\r\n\t\t\t\t\tuni.request({\r\n\t\t\t\t\t\turl:newurl,\r\n\t\t\t\t\t\tmethod:'GET',\r\n\t\t\t\t\t\tsuccess:(res2) => {\r\n\t\t\t\t\t\t\tif (res.statusCode === 200 && Array.isArray(res.data) && res.data.length > 0){\r\n\t\t\t\t\t\t\t\tconst desc = res.data[0][5];\r\n\t\t\t\t\t\t\t\tthis.$set(this.descriptionMap, id, [{ content: desc }]);\r\n\t\t\t\t\t\t\t\tuni.setStorageSync(cacheKey, desc);\t\t\t\t\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\tfail: () => {\r\n\t\t\t\t\t\t\tconsole.error('备用服务器请求失败');\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t},\r\n\t\t\t\tfail:() => {\r\n\t\t\t\t\tconsole.error('备用地址请求失败');\r\n\t\t\t\t}\r\n\t\t\t});\n          }\n        });\n      });\n    },\n    goToDetail(item) {\n      if (!item?.id) return;\n      uni.navigateTo({\n        url: `/pages/tabbar/lecture/lectureDetail?id=${item.id}`\n      });\n    }\n  }\n};\n</script>\n\n<style>\n.tabs {\n  display: flex;\n  flex-direction: column;\n  height: 100vh;\n  background-color: #f8f8f8;\n}\n.tab-bar {\n  height: 42px;\n  display: flex;\n  flex-direction: row;\n  border-bottom: 1px solid #ddd;\n  background-color: #f8f8f8;\n}\n.uni-tab-item {\n  flex: 1;\n  display: flex;\n  justify-content: center;\n  align-items: center;\n}\n.uni-tab-item-title {\n  font-size: 15px;\n  color: #555;\n  line-height: 40px;\n}\n.uni-tab-item-active .uni-tab-item-title {\n  color: #aa00ff;\n  font-weight: bold;\n  border-bottom: 2px solid #aa00ff;\n}\n.tab-box {\n  flex: 1;\n  display: flex;\n  flex-direction: column;\n  overflow: hidden;\n}\n.swiper-item {\n  flex: 1;\n  display: flex;\n  flex-direction: column;\n  height: 100%;\n  box-sizing: border-box;\n}\n.scroll-list {\n  flex: 1;\n  height: 100%;\n  overflow-y: auto;\n  box-sizing: border-box;\n  padding: 20rpx;\n}\n.list-item-box {\n  display: flex;\n  flex-direction: column;\n}\n.title {\n  font-weight: bold;\n  font-size: 16px;\n  margin-bottom: 4rpx;\n  color: #333;\n}\n.desc {\n  font-size: 14px;\n  color: #666;\n  white-space: pre-wrap;\n}\n.empty-tip {\n  font-size: 14px;\n  color: #999;\n  text-align: center;\n  margin-top: 40rpx;\n}\n.bottom-spacer {\n  height: 80rpx; /* 占位以避免底部被遮挡 */\n  flex-shrink: 0;\n}\n</style>\n","import MiniProgramPage from 'D:/NJU/code/NJUnews/code/njunews/pages/tabbar/lecture/lecture.vue'\nwx.createPage(MiniProgramPage)"],"names":["useUserStore","uni","res"],"mappings":"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"}